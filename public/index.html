<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>B-Roll Index</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #0a0a0a; color: #e0e0e0; min-height: 100vh; }

    /* ── Layout ── */
    .app { display: flex; flex-direction: column; min-height: 100vh; }

    /* ── Project screen header (back nav) ── */
    .header { background: #0a0a0a; border-bottom: 1px solid #1a1a1a; padding: 0 32px; display: flex; align-items: stretch; gap: 0; position: sticky; top: 0; z-index: 50; min-height: 82px; }
    .header h1 { font-size: clamp(1.8rem, 3vw, 2.6rem); font-weight: 900; color: #fff; letter-spacing: -0.04em; line-height: 0.95; }
    .header .back-link { color: #686868; text-decoration: none; font-size: 0.78rem; display: flex; align-items: center; gap: 5px; transition: color 0.15s; padding-right: 24px; margin-right: 24px; border-right: 1px solid #1e1e1e; text-transform: uppercase; letter-spacing: 0.08em; font-weight: 600; }
    .header .back-link:hover { color: #aaa; }
    .header-left { display: flex; align-items: center; gap: 0; flex: 1; }
    .header-stats { display: flex; align-items: center; gap: 34px; padding-left: 32px; margin-left: auto; }
    .header-stat { display: flex; flex-direction: column; align-items: flex-end; gap: 2px; }
    .header-stat-val { font-size: clamp(1.6rem, 2.2vw, 2.1rem); font-weight: 800; color: #fff; line-height: 1; letter-spacing: -0.04em; }
    .header-stat-label { font-size: 0.65rem; color: #b5b5b5; text-transform: uppercase; letter-spacing: 0.12em; }
    .main { flex: 1; padding: 0 32px 40px; max-width: 1600px; margin: 0 auto; width: 100%; }

    /* ── Home screen hero header ── */
    .home-header { padding: 48px 32px 36px; max-width: 1600px; margin: 0 auto; width: 100%; }
    .home-header-inner { position: relative; isolation: isolate; overflow: hidden; display: flex; align-items: flex-end; justify-content: space-between; gap: 24px; border: 1px solid #1a1a1a; border-radius: 14px; padding: 34px; min-height: 320px; }
    .home-header-inner::before { content: ""; position: absolute; inset: 0; background: url('/assets/hero-image.jpeg') center 42% / cover no-repeat; opacity: 1; z-index: -2; }
    .home-header-inner::after { content: ""; position: absolute; inset: 0; background: linear-gradient(90deg, rgba(10,10,10,0.48) 0%, rgba(10,10,10,0.28) 38%, rgba(10,10,10,0.22) 68%, rgba(10,10,10,0.45) 100%), linear-gradient(180deg, rgba(10,10,10,0.10) 0%, rgba(10,10,10,0.35) 100%); z-index: -1; }
    .home-wordmark { display: flex; flex-direction: column; gap: 6px; }
    .home-wordmark h1 { font-size: clamp(3rem, 6vw, 5.4rem); font-weight: 900; color: #fff; letter-spacing: -0.045em; line-height: 0.92; text-shadow: 0 10px 30px rgba(0,0,0,0.6); }
    .home-wordmark p { font-size: clamp(1.05rem, 1.8vw, 1.5rem); color: #e0e0e0; letter-spacing: 0.005em; text-shadow: 0 8px 20px rgba(0,0,0,0.55); }
    .home-stats-summary { display: flex; gap: 28px; }
    .home-stat { display: flex; flex-direction: column; align-items: flex-end; gap: 2px; }
    .home-stat-val { font-size: clamp(2rem, 3.4vw, 3.1rem); font-weight: 800; color: #fff; line-height: 1; letter-spacing: -0.035em; text-shadow: 0 8px 24px rgba(0,0,0,0.6); }
    .home-stat-label { font-size: 0.75rem; color: #dfdfdf; text-transform: uppercase; letter-spacing: 0.12em; }

    /* ── Tabs ── */
    .tabs { display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 1px solid #1a1a1a; margin-top: 24px; padding-bottom: 10px; }
    .tab { padding: 10px 16px; background: #101010; border: 1px solid #242424; border-radius: 8px; color: #8f8f8f; cursor: pointer; font-size: 0.9rem; font-weight: 700; transition: color 0.15s, background 0.15s, border-color 0.15s; letter-spacing: 0.06em; text-transform: uppercase; }
    .tab.active { color: #fff; background: #161616; border-color: #3a3a3a; }
    .tab:hover:not(.active) { color: #d0d0d0; border-color: #313131; background: #141414; }

    /* ── Projects grid ── */
    .projects-section { padding: 0 32px 48px; max-width: 1600px; margin: 0 auto; width: 100%; }
    .projects-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(420px, 1fr)); gap: 16px; margin-bottom: 40px; }

    /* ── Project card ── */
    .project-card { background: #111; border: 1px solid #1c1c1c; border-radius: 14px; overflow: hidden; display: flex; flex-direction: column; cursor: pointer; transition: border-color 0.2s, transform 0.2s, box-shadow 0.2s; position: relative; }
    .project-card:hover { border-color: #2e2e2e; transform: translateY(-3px); box-shadow: 0 20px 60px rgba(0,0,0,0.6); }
    .project-card-logo-wrap { position: relative; overflow: hidden; aspect-ratio: 1/1; background: #0c0c0c; border-bottom: 1px solid #1a1a1a; }
    .project-card-logo { width: 100%; height: 100%; object-fit: contain; display: block; transition: transform 0.3s ease; }
    .project-card:hover .project-card-logo { transform: scale(1.02); }
    .project-card-logo-overlay { position: absolute; inset: 0; background: linear-gradient(to bottom, rgba(0,0,0,0.02) 45%, rgba(0,0,0,0.22) 100%); }
    .project-card-logo-placeholder { width: 100%; aspect-ratio: 1/1; background: #0e0e0e; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; color: #2e2e2e; border-bottom: 1px solid #1a1a1a; }
    .project-card-body { padding: 16px 20px 18px; display: flex; flex-direction: column; gap: 12px; flex: 1; }
    .project-card-title { display: flex; align-items: center; gap: 8px; }
    .project-card-title h2 { font-size: 1.05rem; font-weight: 700; color: #f0f0f0; letter-spacing: -0.02em; flex: 1; }
    .project-card-actions { display: flex; align-items: center; gap: 6px; }
    .rename-btn { background: none; border: none; color: #555; cursor: pointer; padding: 3px 5px; font-size: 0.8rem; line-height: 1; transition: color 0.15s; flex-shrink: 0; border-radius: 4px; }
    .rename-btn:hover { color: #fff; background: #222; }
    .rename-btn svg { width: 13px; height: 13px; display: block; }
    .project-card .meta { display: flex; gap: 20px; align-items: center; }
    .project-card .meta-stat { display: flex; flex-direction: column; gap: 1px; }
    .project-card .meta-stat .meta-val { font-size: 1.5rem; font-weight: 700; color: #fff; line-height: 1; letter-spacing: -0.03em; }
    .project-card .meta-stat .meta-label { font-size: 0.62rem; color: #555; text-transform: uppercase; letter-spacing: 0.08em; }
    .project-card .card-footer { display: flex; align-items: center; justify-content: space-between; padding-top: 12px; border-top: 1px solid #1a1a1a; }
    .remove-link { background: none; border: none; color: #666; font-size: 0.72rem; cursor: pointer; padding: 0; transition: color 0.15s; }
    .remove-link:hover { color: #f66; }
    .rename-input { background: #0a0a0a; border: 1px solid #4a9eff; border-radius: 5px; color: #fff; font-size: 1.05rem; font-weight: 700; padding: 2px 8px; width: 100%; outline: none; }

    /* ── Buttons ── */
    .btn { padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.84rem; font-weight: 500; transition: background 0.15s, opacity 0.15s; letter-spacing: 0.01em; }
    .btn-primary { background: #fff; color: #000; }
    .btn-primary:hover { background: #e8e8e8; }
    .btn-primary:disabled { opacity: 0.35; cursor: not-allowed; }
    .btn-secondary { background: #1e1e1e; color: #aaa; border: 1px solid #2a2a2a; }
    .btn-secondary:hover { background: #252525; color: #ccc; }
    .btn-danger { background: #1a0808; color: #f66; border: 1px solid #2a1010; }
    .btn-danger:hover { background: #220a0a; }
    .btn-sm { padding: 5px 11px; font-size: 0.78rem; }

    /* ── Register card ── */
    .register-section { border-top: 1px solid #141414; padding-top: 32px; }
    .register-section-label { font-size: 0.65rem; color: #555; text-transform: uppercase; letter-spacing: 0.12em; font-weight: 600; margin-bottom: 16px; }
    .register-card { background: #0e0e0e; border: 1px solid #272727; border-radius: 14px; padding: 24px 26px; }
    .form-row { display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap; }
    .form-group { display: flex; flex-direction: column; gap: 6px; flex: 1; min-width: 200px; }
    .form-group label { font-size: 0.72rem; color: #777; text-transform: uppercase; letter-spacing: 0.08em; font-weight: 600; }
    .form-group input, .form-group textarea, .form-group select { background: #0a0a0a; border: 1px solid #303030; border-radius: 8px; color: #d0d0d0; padding: 9px 12px; font-size: 0.85rem; font-family: inherit; transition: border-color 0.15s; }
    .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #555; }
    .form-group input::placeholder { color: #484848; }
    .form-group textarea { resize: vertical; min-height: 70px; }

    .input-browse { display: flex; gap: 6px; align-items: center; }
    .input-browse input { flex: 1; min-width: 0; }
    .btn-browse { background: #1a1a1a; border: 1px solid #303030; border-radius: 8px; color: #777; padding: 9px 12px; font-size: 0.78rem; cursor: pointer; white-space: nowrap; flex-shrink: 0; transition: background 0.15s, color 0.15s, border-color 0.15s; }
    .btn-browse:hover { background: #222; color: #aaa; border-color: #444; }
    .error-msg { color: #f66; font-size: 0.8rem; margin-top: 8px; }
    .success-msg { color: #4f4; font-size: 0.8rem; margin-top: 8px; }
    .empty-state { color: #4a4a4a; text-align: center; padding: 60px 40px; font-size: 0.88rem; letter-spacing: 0.02em; }

    /* ── Filters ── */
    .filter-bar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 16px; }
    .filter-bar input[type="text"] { background: #111; border: 1px solid #252525; border-radius: 8px; color: #ddd; padding: 8px 14px; font-size: 0.84rem; flex: 1; min-width: 200px; transition: border-color 0.15s; }
    .filter-bar input[type="text"]::placeholder { color: #3a3a3a; }
    .filter-bar input[type="text"]:focus { outline: none; border-color: #383838; }
    .filter-bar select { background: #111; border: 1px solid #252525; border-radius: 8px; color: #aaa; padding: 8px 10px; font-size: 0.82rem; cursor: pointer; }
    .filter-bar select:focus { outline: none; }

    /* ── Clip grid ── */
    .clip-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(var(--card-min, 220px), 1fr)); gap: 10px; }
    .size-controls { display: flex; align-items: center; gap: 4px; margin-left: auto; }
    .size-btn { background: #181818; border: 1px solid #2a2a2a; border-radius: 5px; color: #666; width: 28px; height: 28px; cursor: pointer; font-size: 1.1rem; line-height: 1; display: flex; align-items: center; justify-content: center; transition: background 0.15s, color 0.15s; }
    .size-btn:hover:not(:disabled) { background: #222; color: #bbb; }
    .size-btn:disabled { opacity: 0.25; cursor: not-allowed; }

    /* ── Clip card — overlay design ── */
    .clip-card { position: relative; border-radius: 10px; overflow: hidden; cursor: pointer; background: #111; transition: transform 0.18s ease, box-shadow 0.18s ease; }
    .clip-card:hover { transform: translateY(-2px); box-shadow: 0 12px 40px rgba(0,0,0,0.7); }
    .clip-thumb { width: 100%; display: block; }
    .clip-thumb-placeholder { width: 100%; aspect-ratio: 9/16; background: #111; display: flex; align-items: center; justify-content: center; color: #2a2a2a; font-size: 0.75rem; }
    .clip-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.92) 0%, rgba(0,0,0,0.8) 18%, transparent 38%); display: flex; flex-direction: column; justify-content: flex-end; padding: 10px; pointer-events: none; }
    .clip-overlay-inner { pointer-events: auto; }
    .clip-title { font-size: 0.75rem; font-weight: 500; color: #e8e8e8; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.35; }
    .clip-source { font-size: 0.68rem; color: #888; margin-bottom: 5px; }
    .clip-source .source-file { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #777; }
    .clip-source .source-file-link { cursor: pointer; pointer-events: auto; }
    .clip-source .source-file-link:hover { color: #aaa; text-decoration: underline; }
    .clip-source .timecode { display: inline-block; color: rgba(255,255,255,0.45); font-family: monospace; font-size: 0.65rem; margin-top: 2px; }
    .clip-tags { display: flex; flex-wrap: wrap; gap: 3px; }
    .tag { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 0.64rem; font-weight: 500; letter-spacing: 0.01em; }
    .tag-shot { background: rgba(80,130,200,0.2); color: #7aaecc; }
    .tag-tech { background: rgba(80,180,100,0.18); color: #7cc488; }
    .tag-equip { background: rgba(160,100,200,0.18); color: #b891cc; }
    .tag-score { background: rgba(0,0,0,0.45); border: 1px solid rgba(255,255,255,0.1); font-weight: 600; }
    .tag-custom { background: rgba(255,255,255,0.06); color: #888; }

    /* ── Edit modal ── */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .modal { background: #1a1a1a; border: 1px solid #444; border-radius: 12px; padding: 24px; width: 100%; max-width: 560px; max-height: 90vh; overflow-y: auto; }
    .modal h2 { font-size: 1rem; font-weight: 600; margin-bottom: 18px; }
    .modal-field { margin-bottom: 14px; }
    .modal-field label { display: block; font-size: 0.8rem; color: #888; margin-bottom: 5px; }
    .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px; }
    .modal-thumb { width: 100%; border-radius: 6px; margin-bottom: 16px; }

    /* ── Score badge ── */
    .score-excellent { color: #6f6; }
    .score-good { color: #af6; }
    .score-marginal { color: #fa6; }
    .score-notbroll { color: #f66; }

    /* ── Import tab ── */
    .video-list { display: flex; flex-direction: column; gap: 8px; margin-top: 12px; }
    .video-row { background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 8px; padding: 12px 16px; display: flex; align-items: center; gap: 12px; }
    .video-row .vname { flex: 1; font-size: 0.85rem; color: #ccc; }
    .video-row .vmeta { font-size: 0.75rem; color: #555; white-space: nowrap; }
    .video-row .vstatus { font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; }
    .vstatus-indexed { background: #1a3a1a; color: #6b6; }
    .vstatus-new { background: #2a2a1a; color: #996; }
    .log-box { background: #0a0a0a; border: 1px solid #333; border-radius: 6px; padding: 12px; font-family: monospace; font-size: 0.75rem; color: #8a8; max-height: 280px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; margin-top: 12px; }

    /* ── Taxonomy editor ── */
    .taxonomy-section { margin-bottom: 24px; }
    .taxonomy-section h3 { font-size: 0.85rem; font-weight: 600; color: #aaa; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 10px; }
    .tags-input-wrap { display: flex; flex-wrap: wrap; gap: 6px; padding: 8px; background: #111; border: 1px solid #444; border-radius: 6px; min-height: 44px; align-items: center; }
    .tags-input-wrap input { background: none; border: none; color: #e0e0e0; font-size: 0.85rem; outline: none; flex: 1; min-width: 120px; }
    .tag-removable { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 4px; font-size: 0.78rem; cursor: default; }
    .tag-removable button { background: none; border: none; color: inherit; cursor: pointer; opacity: 0.6; padding: 0; line-height: 1; font-size: 0.9em; }
    .tag-removable button:hover { opacity: 1; }
    .score-slider-row { display: flex; align-items: center; gap: 12px; }
    .score-slider-row input[type=range] { flex: 1; accent-color: #4a9eff; }
    .score-slider-row .score-val { font-size: 0.85rem; font-weight: 600; color: #4a9eff; min-width: 36px; }

    /* ── Misc ── */
    .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid #333; border-top-color: #4a9eff; border-radius: 50%; animation: spin 0.7s linear infinite; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .divider { border: none; border-top: 1px solid #222; margin: 20px 0; }
    @media (max-width: 900px) {
      .header { min-height: 68px; padding: 0 16px; }
      .header h1 { font-size: clamp(1.35rem, 6vw, 1.8rem); }
      .header .back-link { padding-right: 12px; margin-right: 12px; font-size: 0.66rem; }
      .header-stats { gap: 14px; padding-left: 14px; }
      .header-stat-val { font-size: 1.25rem; }
      .header-stat-label { font-size: 0.56rem; }
      .home-header { padding: 24px 16px 20px; }
      .home-header-inner { min-height: 240px; padding: 22px 18px; flex-direction: column; align-items: flex-start; justify-content: flex-end; gap: 14px; }
      .home-header-inner::before { background-position: center; }
      .home-stats-summary { gap: 18px; }
      .home-stat { align-items: flex-start; }
      .home-wordmark h1 { font-size: clamp(2.3rem, 10vw, 3.4rem); }
      .home-wordmark p { font-size: 1rem; }
      .home-stat-val { font-size: 1.8rem; }
      .home-stat-label { font-size: 0.7rem; }
      .tabs { gap: 6px; margin-top: 18px; margin-bottom: 18px; padding-bottom: 8px; }
      .tab { padding: 8px 11px; font-size: 0.74rem; letter-spacing: 0.05em; }
    }
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

// ─── Router ──────────────────────────────────────────────────────────────────

function useRoute() {
  const [hash, setHash] = useState(window.location.hash || '#/');
  useEffect(() => {
    const on = () => setHash(window.location.hash || '#/');
    window.addEventListener('hashchange', on);
    return () => window.removeEventListener('hashchange', on);
  }, []);
  const match = hash.match(/^#\/projects\/([^/]+)/);
  return match ? { screen: 'project', slug: match[1] } : { screen: 'projects', slug: null };
}

function navigate(hash) {
  window.location.hash = hash;
}

// ─── API helpers ─────────────────────────────────────────────────────────────

const api = {
  // Projects
  fetchProjects: () => fetch('/api/projects').then(r => r.json()),
  registerProject: (folderPath, name, logoUrl) => fetch('/api/projects', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ folderPath, name, logoUrl }),
  }).then(r => r.json()),
  patchProject: (slug, updates) => fetch(`/api/projects/${slug}`, {
    method: 'PATCH', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(updates),
  }).then(r => r.json()),
  renameProject: (slug, name) => fetch(`/api/projects/${slug}`, {
    method: 'PATCH', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name }),
  }).then(r => r.json()),
  unregisterProject: (slug) => fetch(`/api/projects/${slug}`, { method: 'DELETE' }).then(r => r.json()),

  // Per-project
  fetchIndex: (slug) => fetch(`/api/projects/${slug}/index`).then(r => r.json()),
  fetchTaxonomy: (slug) => fetch(`/api/projects/${slug}/taxonomy`).then(r => r.json()),
  putTaxonomy: (slug, taxonomy) => fetch(`/api/projects/${slug}/taxonomy`, {
    method: 'PUT', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(taxonomy),
  }).then(r => r.json()),
  patchClip: (slug, id, updates) => fetch(`/api/projects/${slug}/clips/${id}`, {
    method: 'PATCH', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(updates),
  }).then(r => r.json()),
  deleteClip: (slug, id) => fetch(`/api/projects/${slug}/clips/${id}`, { method: 'DELETE' }).then(r => r.json()),
  fetchVideos: (slug) => fetch(`/api/projects/${slug}/videos`).then(r => r.json()),
  startAnalysis: (slug, filename) => fetch(`/api/projects/${slug}/analyze`, {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(filename ? { filename } : {}),
  }).then(r => r.json()),
  fetchAnalysisStatus: (slug) => fetch(`/api/projects/${slug}/analyze/status`).then(r => r.json()),
  revealInFinder: (filePath) => fetch('/api/reveal', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ filePath }),
  }).then(r => r.json()),
  pick: (type) => fetch('/api/pick', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ type }),
  }).then(r => r.json()),
};

// ─── Tag component ────────────────────────────────────────────────────────────

function Tag({ text, type }) {
  const cls = {
    shot: 'tag-shot', tech: 'tag-tech', equip: 'tag-equip', score: 'tag-score',
  }[type] || 'tag-custom';
  return <span className={`tag ${cls}`}>{text}</span>;
}

// ─── TagsField (editable tags input) ─────────────────────────────────────────

function TagsField({ values, onChange, placeholder, colorClass }) {
  const [input, setInput] = useState('');
  const inputRef = useRef();

  function add(val) {
    const v = val.trim().toLowerCase().replace(/\s+/g, '-');
    if (v && !values.includes(v)) onChange([...values, v]);
    setInput('');
  }

  function remove(v) {
    onChange(values.filter(x => x !== v));
  }

  function onKey(e) {
    if (e.key === 'Enter' || e.key === ',') { e.preventDefault(); add(input); }
    else if (e.key === 'Backspace' && !input && values.length) remove(values[values.length - 1]);
  }

  return (
    <div className="tags-input-wrap" onClick={() => inputRef.current?.focus()}>
      {values.map(v => (
        <span key={v} className={`tag-removable ${colorClass || 'tag-custom'}`}>
          {v}
          <button onClick={(e) => { e.stopPropagation(); remove(v); }}>×</button>
        </span>
      ))}
      <input
        ref={inputRef}
        value={input}
        onChange={e => setInput(e.target.value)}
        onKeyDown={onKey}
        onBlur={() => { if (input) add(input); }}
        placeholder={values.length ? '' : (placeholder || 'Type and press Enter…')}
      />
    </div>
  );
}

// ─── ProductsField (preserves original casing) ────────────────────────────────

function ProductsField({ values, onChange }) {
  const [input, setInput] = useState('');
  const inputRef = useRef();

  function add(val) {
    const v = val.trim();
    if (v && !values.includes(v)) onChange([...values, v]);
    setInput('');
  }

  function remove(v) {
    onChange(values.filter(x => x !== v));
  }

  function onKey(e) {
    if (e.key === 'Enter') { e.preventDefault(); add(input); }
    else if (e.key === 'Backspace' && !input && values.length) remove(values[values.length - 1]);
  }

  return (
    <div className="tags-input-wrap" onClick={() => inputRef.current?.focus()}>
      {values.map(v => (
        <span key={v} className="tag-removable tag-equip">
          {v}
          <button onClick={(e) => { e.stopPropagation(); remove(v); }}>×</button>
        </span>
      ))}
      <input
        ref={inputRef}
        value={input}
        onChange={e => setInput(e.target.value)}
        onKeyDown={onKey}
        onBlur={() => { if (input) add(input); }}
        placeholder={values.length ? '' : 'Type product name, press Enter…'}
      />
    </div>
  );
}

// ─── ClipCard ─────────────────────────────────────────────────────────────────

function scoreClass(s) {
  if (s >= 0.8) return 'score-excellent';
  if (s >= 0.5) return 'score-good';
  if (s >= 0.3) return 'score-marginal';
  return 'score-notbroll';
}

// Blank 1×1 GIF — used to pause animated GIFs when off-screen
const BLANK_GIF = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';

function ClipCard({ clip, onEdit }) {
  const imgRef = useRef();
  const srcRef = useRef(clip.thumbnail);

  useEffect(() => {
    if (!clip.thumbnail || !imgRef.current) return;
    const el = imgRef.current;
    const obs = new IntersectionObserver(
      ([entry]) => {
        if (entry.isIntersecting) {
          el.src = srcRef.current;
        } else {
          el.src = BLANK_GIF;
        }
      },
      { rootMargin: '200px' }
    );
    obs.observe(el);
    return () => obs.disconnect();
  }, [clip.thumbnail]);

  return (
    <div className="clip-card" onClick={() => onEdit(clip)}>
      {clip.thumbnail
        ? <img ref={imgRef} className="clip-thumb" src={BLANK_GIF} alt="" />
        : <div className="clip-thumb-placeholder">no preview</div>
      }
      <div className="clip-overlay">
        <div className="clip-overlay-inner">
          <div className="clip-title" title={clip.description}>{clip.description || clip.id}</div>
          {(clip.sourceFilename || clip.startTime) && (
            <div className="clip-source">
              {clip.sourceFilename && (
                <span
                  className="source-file source-file-link"
                  title={`Reveal in Finder: ${clip.sourceFilename}`}
                  onClick={e => { e.stopPropagation(); api.revealInFinder(clip.sourceFilePath || clip.sourceFilename); }}
                >
                  {clip.sourceFilename.replace(/\.[^.]+$/, '')}
                </span>
              )}
              {clip.startTime && clip.endTime && (
                <span className="timecode"> · {clip.startTime}–{clip.endTime}</span>
              )}
            </div>
          )}
          <div className="clip-tags">
            {clip.shotType && <Tag text={clip.shotType} type="shot" />}
            {clip.technique && <Tag text={clip.technique} type="tech" />}
            {clip.brollScore != null && (
              <span className={`tag tag-score ${scoreClass(clip.brollScore)}`}>
                {(clip.brollScore * 100).toFixed(0)}%
              </span>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

// ─── EditModal ────────────────────────────────────────────────────────────────

function EditModal({ clip, slug, taxonomy, onClose, onSave, onDelete }) {
  const [form, setForm] = useState({
    description: clip.description || '',
    shotType: clip.shotType || '',
    technique: clip.technique || '',
    equipment: clip.equipment || [],
    products: clip.products || [],
    subjectDescriptors: clip.subjectDescriptors || clip.beanDescriptors || [],
    brollScore: clip.brollScore ?? '',
    notes: clip.notes || '',
  });
  const [saving, setSaving] = useState(false);
  const [deleting, setDeleting] = useState(false);

  function set(k, v) { setForm(f => ({ ...f, [k]: v })); }

  async function save() {
    setSaving(true);
    const updated = await api.patchClip(slug, clip.id, {
      description: form.description,
      shotType: form.shotType,
      technique: form.technique,
      equipment: form.equipment,
      products: form.products,
      subjectDescriptors: form.subjectDescriptors,
      brollScore: form.brollScore === '' ? null : parseFloat(form.brollScore),
      notes: form.notes,
    });
    setSaving(false);
    onSave(updated);
  }

  async function del() {
    if (!confirm('Delete this clip from the index? (Does not delete the video.)')) return;
    setDeleting(true);
    await api.deleteClip(slug, clip.id);
    setDeleting(false);
    onDelete(clip.id);
  }

  const shotTypes = taxonomy?.shotTypes || [];
  const techniques = taxonomy?.techniques || [];

  return (
    <div className="modal-overlay" onClick={e => e.target === e.currentTarget && onClose()}>
      <div className="modal">
        <h2>Edit Clip</h2>

        {clip.thumbnail && <img className="modal-thumb" src={clip.thumbnail} alt="" />}

        {(clip.sourceFilename || clip.startTime) && (
          <div className="modal-field">
            <label>Source file &amp; timecode</label>
            <div style={{ background: '#111', border: '1px solid #333', borderRadius: '6px', padding: '8px 10px', lineHeight: '1.6' }}>
              {clip.sourceFilename && (
                <div
                  style={{ fontSize: '0.85rem', color: '#ccc', fontFamily: 'monospace', wordBreak: 'break-all', cursor: 'pointer', textDecoration: 'underline', textDecorationColor: '#444' }}
                  title="Reveal in Finder"
                  onClick={() => api.revealInFinder(clip.sourceFilePath || clip.sourceFilename)}
                  onMouseEnter={e => e.currentTarget.style.color = '#4a9eff'}
                  onMouseLeave={e => e.currentTarget.style.color = '#ccc'}
                >{clip.sourceFilename}</div>
              )}
              {clip.startTime && clip.endTime && (
                <div style={{ fontSize: '0.9rem', color: '#4a9eff', fontFamily: 'monospace', fontWeight: 600 }}>{clip.startTime} – {clip.endTime}</div>
              )}
            </div>
          </div>
        )}

        <div className="modal-field">
          <label>Description</label>
          <div className="form-group">
            <textarea value={form.description} onChange={e => set('description', e.target.value)} rows={2} />
          </div>
        </div>

        <div className="modal-field">
          <label>Shot Type</label>
          <div className="form-group">
            <select value={form.shotType} onChange={e => set('shotType', e.target.value)}>
              <option value="">— none —</option>
              {shotTypes.map(s => <option key={s} value={s}>{s}</option>)}
            </select>
          </div>
        </div>

        <div className="modal-field">
          <label>Technique</label>
          <div className="form-group">
            <select value={form.technique} onChange={e => set('technique', e.target.value)}>
              <option value="">— none —</option>
              {techniques.map(t => <option key={t} value={t}>{t}</option>)}
            </select>
          </div>
        </div>

        <div className="modal-field">
          <label>Equipment / Props</label>
          <TagsField values={form.equipment} onChange={v => set('equipment', v)} colorClass="tag-equip" />
        </div>

        <div className="modal-field">
          <label>Products / Brands</label>
          <ProductsField values={form.products} onChange={v => set('products', v)} />
        </div>

        <div className="modal-field">
          <label>Subject Descriptors</label>
          <TagsField values={form.subjectDescriptors} onChange={v => set('subjectDescriptors', v)} colorClass="tag-custom" />
        </div>

        <div className="modal-field">
          <label>B-Roll Score (0–1)</label>
          <div className="form-group">
            <input type="number" min="0" max="1" step="0.01" value={form.brollScore}
              onChange={e => set('brollScore', e.target.value)} />
          </div>
        </div>

        <div className="modal-field">
          <label>Notes</label>
          <div className="form-group">
            <textarea value={form.notes} onChange={e => set('notes', e.target.value)} rows={2} />
          </div>
        </div>

        <div className="modal-actions">
          <button className="btn btn-danger btn-sm" onClick={del} disabled={deleting}>
            {deleting ? 'Deleting…' : 'Delete'}
          </button>
          <button className="btn btn-secondary" onClick={onClose}>Cancel</button>
          <button className="btn btn-primary" onClick={save} disabled={saving}>
            {saving ? 'Saving…' : 'Save'}
          </button>
        </div>
      </div>
    </div>
  );
}

// ─── ClipsTab ─────────────────────────────────────────────────────────────────

const CARD_SIZES = [160, 200, 240, 300, 380];

function ClipsTab({ slug, index, taxonomy, onIndexChange }) {
  const [search, setSearch] = useState('');
  const [filterShot, setFilterShot] = useState('');
  const [filterTech, setFilterTech] = useState('');
  const [filterScore, setFilterScore] = useState('all');
  const [editClip, setEditClip] = useState(null);
  const [sizeIdx, setSizeIdx] = useState(3);

  const clips = index?.clips || [];

  const filtered = clips.filter(c => {
    if (filterShot && c.shotType !== filterShot) return false;
    if (filterTech && c.technique !== filterTech) return false;
    if (filterScore === 'excellent' && c.brollScore < 0.8) return false;
    if (filterScore === 'good' && (c.brollScore < 0.5 || c.brollScore >= 0.8)) return false;
    if (filterScore === 'marginal' && (c.brollScore < 0.3 || c.brollScore >= 0.5)) return false;
    if (search) {
      const q = search.toLowerCase();
      const haystack = [c.description, c.shotType, c.technique, c.sourceFilename, ...(c.equipment || []), ...(c.products || []), ...(c.subjectDescriptors || [])].join(' ').toLowerCase();
      if (!haystack.includes(q)) return false;
    }
    return true;
  });

  const shotTypes = [...new Set(clips.map(c => c.shotType).filter(Boolean))].sort();
  const techniques = [...new Set(clips.map(c => c.technique).filter(Boolean))].sort();

  function handleSave(updated) {
    const newClips = (index.clips || []).map(c => c.id === updated.id ? { ...c, ...updated } : c);
    onIndexChange({ ...index, clips: newClips });
    setEditClip(null);
  }

  function handleDelete(id) {
    const newClips = (index.clips || []).filter(c => c.id !== id);
    onIndexChange({ ...index, clips: newClips });
    setEditClip(null);
  }

  return (
    <div>
      <div className="filter-bar">
        <input type="text" placeholder="Search clips…" value={search} onChange={e => setSearch(e.target.value)} />
        <select value={filterShot} onChange={e => setFilterShot(e.target.value)}>
          <option value="">All shot types</option>
          {shotTypes.map(s => <option key={s} value={s}>{s}</option>)}
        </select>
        <select value={filterTech} onChange={e => setFilterTech(e.target.value)}>
          <option value="">All techniques</option>
          {techniques.map(t => <option key={t} value={t}>{t}</option>)}
        </select>
        <select value={filterScore} onChange={e => setFilterScore(e.target.value)}>
          <option value="all">All scores</option>
          <option value="excellent">Excellent (≥80%)</option>
          <option value="good">Good (50–80%)</option>
          <option value="marginal">Marginal (30–50%)</option>
        </select>
        <div className="size-controls">
          <button className="size-btn" title="Smaller" disabled={sizeIdx === 0} onClick={() => setSizeIdx(i => i - 1)}>−</button>
          <button className="size-btn" title="Larger" disabled={sizeIdx === CARD_SIZES.length - 1} onClick={() => setSizeIdx(i => i + 1)}>+</button>
        </div>
      </div>

      <div style={{ color: '#555', fontSize: '0.8rem', marginBottom: '12px' }}>
        {filtered.length} of {clips.length} clips
      </div>

      {filtered.length === 0
        ? <div className="empty-state">No clips match your filters.</div>
        : (
          <div className="clip-grid" style={{ '--card-min': `${CARD_SIZES[sizeIdx]}px` }}>
            {filtered.map(clip => (
              <ClipCard key={clip.id} clip={clip} slug={slug} onEdit={setEditClip} />
            ))}
          </div>
        )
      }

      {editClip && (
        <EditModal
          clip={editClip}
          slug={slug}
          taxonomy={taxonomy}
          onClose={() => setEditClip(null)}
          onSave={handleSave}
          onDelete={handleDelete}
        />
      )}
    </div>
  );
}

// ─── ImportTab ────────────────────────────────────────────────────────────────

function ImportTab({ slug }) {
  const [videos, setVideos] = useState([]);
  const [sourceDir, setSourceDir] = useState(null);
  const [loading, setLoading] = useState(true);
  const [job, setJob] = useState(null);
  const logRef = useRef();

  async function loadVideos() {
    setLoading(true);
    const data = await api.fetchVideos(slug);
    setVideos(data.videos || []);
    setSourceDir(data.sourceDir);
    setLoading(false);
  }

  useEffect(() => { loadVideos(); }, [slug]);

  // Poll for job status
  useEffect(() => {
    if (!job || job.status !== 'running') return;
    const interval = setInterval(async () => {
      const status = await api.fetchAnalysisStatus(slug);
      setJob(status);
      if (status.status !== 'running') {
        clearInterval(interval);
        loadVideos();
      }
    }, 2000);
    return () => clearInterval(interval);
  }, [job?.status, slug]);

  // Auto-scroll log
  useEffect(() => {
    if (logRef.current) logRef.current.scrollTop = logRef.current.scrollHeight;
  }, [job?.log]);

  async function analyze(filename) {
    const result = await api.startAnalysis(slug, filename);
    if (result.error) { alert(result.error); return; }
    setJob(result.job || { status: 'running', log: [] });
  }

  async function analyzeAll() {
    const result = await api.startAnalysis(slug, null);
    if (result.error) { alert(result.error); return; }
    setJob(result.job || { status: 'running', log: [] });
  }

  const newVideos = videos.filter(v => !v.indexed);

  return (
    <div>
      {sourceDir && (
        <div style={{ fontSize: '0.78rem', color: '#555', marginBottom: '12px', fontFamily: 'monospace' }}>
          {sourceDir}
        </div>
      )}

      <div style={{ display: 'flex', gap: '10px', marginBottom: '16px', alignItems: 'center' }}>
        <button
          className="btn btn-primary"
          disabled={newVideos.length === 0 || job?.status === 'running'}
          onClick={analyzeAll}
        >
          {job?.status === 'running' ? <><span className="spinner" /> Analyzing…</> : `Analyze ${newVideos.length} new video${newVideos.length !== 1 ? 's' : ''}`}
        </button>
        <button className="btn btn-secondary btn-sm" onClick={loadVideos} disabled={loading}>
          Refresh
        </button>
      </div>

      {job && (
        <div style={{ marginBottom: '16px' }}>
          <div style={{ fontSize: '0.82rem', color: job.status === 'completed' ? '#6f6' : job.status === 'failed' ? '#f66' : '#4a9eff', marginBottom: '6px' }}>
            {job.status === 'running' ? `Analyzing: ${job.filename}` : `Analysis ${job.status}`}
          </div>
          <div className="log-box" ref={logRef}>
            {(job.log || []).join('\n') || '(waiting for output…)'}
          </div>
        </div>
      )}

      {loading ? <div className="empty-state"><span className="spinner" /></div> : (
        <div className="video-list">
          {videos.map(v => (
            <div className="video-row" key={v.filename}>
              <div className="vname">{v.filename}</div>
              <div className="vmeta">{v.sizeMB} MB{v.clipCount ? ` · ${v.clipCount} clips` : ''}</div>
              <span className={`vstatus ${v.indexed ? 'vstatus-indexed' : 'vstatus-new'}`}>
                {v.indexed ? 'indexed' : 'new'}
              </span>
              <button
                className="btn btn-secondary btn-sm"
                disabled={job?.status === 'running'}
                onClick={() => analyze(v.filename)}
              >
                {v.indexed ? 'Re-analyze' : 'Analyze'}
              </button>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

// ─── TaxonomyEditor ───────────────────────────────────────────────────────────

function TaxonomyEditor({ slug }) {
  const [tax, setTax] = useState(null);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [saveMsg, setSaveMsg] = useState('');

  useEffect(() => {
    setLoading(true);
    api.fetchTaxonomy(slug).then(t => { setTax(t); setLoading(false); });
  }, [slug]);

  function set(k, v) { setTax(t => ({ ...t, [k]: v })); }
  function setScore(k, v) {
    setTax(t => ({ ...t, brollScoreGuide: { ...t.brollScoreGuide, [k]: { ...t.brollScoreGuide[k], ...v } } }));
  }

  async function save() {
    setSaving(true);
    setSaveMsg('');
    await api.putTaxonomy(slug, tax);
    setSaving(false);
    setSaveMsg('Saved!');
    setTimeout(() => setSaveMsg(''), 2000);
  }

  if (loading) return <div className="empty-state"><span className="spinner" /></div>;
  if (!tax) return <div className="empty-state">No taxonomy found.</div>;

  return (
    <div style={{ maxWidth: '700px' }}>

      <div className="taxonomy-section">
        <h3>Content Context</h3>
        <div className="form-group">
          <label style={{ fontSize: '0.78rem', color: '#666', marginBottom: '5px', display: 'block' }}>
            Describe your content to help the AI classifier. E.g. "This is a specialty coffee YouTube channel."
          </label>
          <textarea
            value={tax.promptContext || ''}
            onChange={e => set('promptContext', e.target.value)}
            rows={3}
            placeholder="Leave blank for generic classification…"
          />
        </div>
      </div>

      <div className="taxonomy-section">
        <h3>Shot Types</h3>
        <TagsField values={tax.shotTypes || []} onChange={v => set('shotTypes', v)} colorClass="tag-shot" />
      </div>

      <div className="taxonomy-section">
        <h3>Techniques</h3>
        <TagsField values={tax.techniques || []} onChange={v => set('techniques', v)} colorClass="tag-tech" />
      </div>

      <div className="taxonomy-section">
        <h3>Equipment / Props</h3>
        <TagsField values={tax.equipment || []} onChange={v => set('equipment', v)} colorClass="tag-equip" />
      </div>

      <div className="taxonomy-section">
        <h3>Products / Brands</h3>
        <ProductsField values={tax.products || []} onChange={v => set('products', v)} />
      </div>

      <div className="taxonomy-section">
        <h3>Subject Descriptors</h3>
        <TagsField values={tax.subjectDescriptors || []} onChange={v => set('subjectDescriptors', v)} colorClass="tag-custom" />
        <div style={{ fontSize: '0.75rem', color: '#555', marginTop: '6px' }}>
          Domain-specific descriptors passed to the classifier. E.g. "light-roast", "ipa", "vegan".
        </div>
      </div>

      <div className="taxonomy-section">
        <h3>Minimum B-Roll Score Threshold</h3>
        <div className="score-slider-row">
          <input type="range" min="0" max="1" step="0.05"
            value={tax.minimumBrollScore ?? 0.5}
            onChange={e => set('minimumBrollScore', parseFloat(e.target.value))}
          />
          <span className="score-val">{((tax.minimumBrollScore ?? 0.5) * 100).toFixed(0)}%</span>
        </div>
        <div style={{ fontSize: '0.75rem', color: '#555', marginTop: '4px' }}>
          Clips below this score are excluded from exports and bulk operations.
        </div>
      </div>

      <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
        <button className="btn btn-primary" onClick={save} disabled={saving}>
          {saving ? 'Saving…' : 'Save Taxonomy'}
        </button>
        {saveMsg && <span className="success-msg">{saveMsg}</span>}
      </div>
    </div>
  );
}

// ─── ProjectScreen ────────────────────────────────────────────────────────────

function ProjectScreen({ slug }) {
  const [project, setProject] = useState(null);
  const [index, setIndex] = useState(null);
  const [taxonomy, setTaxonomy] = useState(null);
  const [tab, setTab] = useState('clips');
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    setLoading(true);
    Promise.all([
      api.fetchProjects(),
      api.fetchIndex(slug),
      api.fetchTaxonomy(slug),
    ]).then(([registry, idx, tax]) => {
      setProject((registry.projects || []).find(p => p.slug === slug) || null);
      setIndex(idx);
      setTaxonomy(tax);
      setLoading(false);
    });
  }, [slug]);

  if (loading) {
    return (
      <div className="app">
        <div className="header">
          <a className="back-link" href="#/" onClick={e => { e.preventDefault(); navigate('#/'); }}>← All Projects</a>
        </div>
        <div className="main"><div className="empty-state"><span className="spinner" /></div></div>
      </div>
    );
  }

  const clips = index?.clips || [];
  const videoCount = Object.keys(index?.videos || {}).length;

  const excellentCount = clips.filter(c => c.brollScore >= 0.8).length;
  const goodCount = clips.filter(c => c.brollScore >= 0.5 && c.brollScore < 0.8).length;

  return (
    <div className="app">
      <div className="header">
        <div className="header-left">
          <a className="back-link" href="#/" onClick={e => { e.preventDefault(); navigate('#/'); }}>← All Projects</a>
          <h1>{project?.name || slug}</h1>
        </div>
        <div className="header-stats">
          <div className="header-stat">
            <span className="header-stat-val">{clips.length}</span>
            <span className="header-stat-label">Clips</span>
          </div>
          <div className="header-stat">
            <span className="header-stat-val">{videoCount}</span>
            <span className="header-stat-label">Videos</span>
          </div>
          <div className="header-stat">
            <span className="header-stat-val score-excellent">{excellentCount}</span>
            <span className="header-stat-label">Excellent</span>
          </div>
          <div className="header-stat">
            <span className="header-stat-val score-good">{goodCount}</span>
            <span className="header-stat-label">Good</span>
          </div>
        </div>
      </div>
      <div className="main">
        <div className="tabs">
          <button className={`tab ${tab === 'clips' ? 'active' : ''}`} onClick={() => setTab('clips')}>
            Clips ({clips.length})
          </button>
          <button className={`tab ${tab === 'import' ? 'active' : ''}`} onClick={() => setTab('import')}>
            Import
          </button>
          <button className={`tab ${tab === 'taxonomy' ? 'active' : ''}`} onClick={() => setTab('taxonomy')}>
            Taxonomy
          </button>
        </div>

        {tab === 'clips' && (
          <ClipsTab slug={slug} index={index} taxonomy={taxonomy} onIndexChange={setIndex} />
        )}
        {tab === 'import' && <ImportTab slug={slug} />}
        {tab === 'taxonomy' && <TaxonomyEditor slug={slug} />}
      </div>
    </div>
  );
}

// ─── ProjectsScreen ───────────────────────────────────────────────────────────

function ProjectsScreen() {
  const [projects, setProjects] = useState([]);
  const [loading, setLoading] = useState(true);
  const [folderPath, setFolderPath] = useState('');
  const [projName, setProjName] = useState('');
  const [logoPath, setLogoPath] = useState('');
  const [registering, setRegistering] = useState(false);
  const [registerError, setRegisterError] = useState('');

  async function loadProjects() {
    setLoading(true);
    const data = await api.fetchProjects();
    setProjects(data.projects || []);
    setLoading(false);
  }

  useEffect(() => { loadProjects(); }, []);

  async function register() {
    if (!folderPath.trim()) { setRegisterError('Folder path is required.'); return; }
    setRegistering(true);
    setRegisterError('');
    const result = await api.registerProject(folderPath.trim(), projName.trim() || undefined, logoPath.trim() || undefined);
    if (result.error) {
      setRegisterError(result.error);
      setRegistering(false);
      return;
    }
    setFolderPath('');
    setProjName('');
    setLogoPath('');
    setRegistering(false);
    navigate(`#/projects/${result.project.slug}`);
  }

  const [renamingSlug, setRenamingSlug] = useState(null);
  const [renameValue, setRenameValue] = useState('');
  const renameInputRef = useRef();

  async function unregister(slug, name) {
    if (!confirm(`Remove "${name}" from the project list?\n\nThis does NOT delete any files.`)) return;
    await api.unregisterProject(slug);
    loadProjects();
  }

  function startRename(e, p) {
    e.stopPropagation();
    setRenamingSlug(p.slug);
    setRenameValue(p.name);
    setTimeout(() => renameInputRef.current?.select(), 0);
  }

  async function commitRename(slug) {
    const trimmed = renameValue.trim();
    if (trimmed) await api.renameProject(slug, trimmed);
    setRenamingSlug(null);
    loadProjects();
  }

  async function pickProjectLogo(e, slug) {
    e.stopPropagation();
    const picked = await api.pick('file');
    if (picked.cancelled || !picked.path) return;
    await api.patchProject(slug, { logoUrl: picked.path });
    loadProjects();
  }

  const totalClips = projects.reduce((n, p) => n + (p.clipCount || 0), 0);
  const totalVideos = projects.reduce((n, p) => n + (p.videoCount || 0), 0);

  return (
    <div className="app" style={{ background: '#0a0a0a' }}>

      {/* ── Hero header ── */}
      <div className="home-header">
        <div className="home-header-inner">
          <div className="home-wordmark">
            <h1>B-Roll Index</h1>
            <p>AI-powered B-roll discovery for video creators</p>
          </div>
          {!loading && projects.length > 0 && (
            <div className="home-stats-summary">
              <div className="home-stat">
                <span className="home-stat-val">{projects.length}</span>
                <span className="home-stat-label">Projects</span>
              </div>
              <div className="home-stat">
                <span className="home-stat-val">{totalVideos}</span>
                <span className="home-stat-label">Videos</span>
              </div>
              <div className="home-stat">
                <span className="home-stat-val">{totalClips}</span>
                <span className="home-stat-label">Clips</span>
              </div>
            </div>
          )}
        </div>
      </div>

      {/* ── Projects + Register ── */}
      <div className="projects-section">
        {loading ? (
          <div className="empty-state"><span className="spinner" /></div>
        ) : projects.length === 0 ? (
          <div className="empty-state">No projects yet — register a video folder below to get started.</div>
        ) : (
          <div className="projects-grid">
            {projects.map(p => (
              <div className="project-card" key={p.slug} onClick={() => renamingSlug !== p.slug && navigate(`#/projects/${p.slug}`)}>
                {p.logoUrl
                  ? (
                    <div className="project-card-logo-wrap">
                      <img className="project-card-logo" src={p.logoUrl} alt={p.name} />
                      <div className="project-card-logo-overlay" />
                    </div>
                  )
                  : <div className="project-card-logo-placeholder">🎬</div>
                }
                <div className="project-card-body">
                  {renamingSlug === p.slug ? (
                    <input
                      ref={renameInputRef}
                      className="rename-input"
                      value={renameValue}
                      onChange={e => setRenameValue(e.target.value)}
                      onClick={e => e.stopPropagation()}
                      onKeyDown={e => {
                        if (e.key === 'Enter') commitRename(p.slug);
                        if (e.key === 'Escape') setRenamingSlug(null);
                      }}
                      onBlur={() => commitRename(p.slug)}
                      autoFocus
                    />
                  ) : (
                    <div className="project-card-title">
                      <h2>{p.name}</h2>
                      <div className="project-card-actions">
                        <button className="rename-btn" title="Change logo" aria-label="Change logo" onClick={e => pickProjectLogo(e, p.slug)}>
                          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.4" strokeLinecap="round" strokeLinejoin="round" aria-hidden="true">
                            <rect x="1.8" y="2" width="12.4" height="11.2" rx="1.8" />
                            <circle cx="5.3" cy="5.4" r="1.2" />
                            <path d="M3.4 11l3.2-3.1 2.1 2.1 1.7-1.6 2.2 2.6" />
                          </svg>
                        </button>
                        <button className="rename-btn" title="Rename" onClick={e => startRename(e, p)}>✎</button>
                      </div>
                    </div>
                  )}
                  <div className="meta">
                    <div className="meta-stat">
                      <span className="meta-val">{p.clipCount}</span>
                      <span className="meta-label">Clips</span>
                    </div>
                    <div className="meta-stat">
                      <span className="meta-val">{p.videoCount}</span>
                      <span className="meta-label">Videos</span>
                    </div>
                    {p.lastUpdated && (
                      <div style={{ marginLeft: 'auto', alignSelf: 'flex-end', fontSize: '0.68rem', color: '#555', letterSpacing: '0.02em' }}>
                        {new Date(p.lastUpdated).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}
                      </div>
                    )}
                  </div>
                  <div className="card-footer">
                    <div style={{ fontFamily: 'monospace', fontSize: '0.68rem', color: '#4a4a4a', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', maxWidth: '75%' }}>
                      {p.folderPath}
                    </div>
                    <button className="remove-link" onClick={e => { e.stopPropagation(); unregister(p.slug, p.name); }}>
                      Remove
                    </button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}

        {/* ── Register form ── */}
        <div className="register-section">
          <div className="register-section-label">Add a project</div>
          <div className="register-card">
            <div className="form-row">
              <div className="form-group" style={{ flex: 2 }}>
                <label>Video folder</label>
                <div className="input-browse">
                  <input
                    type="text"
                    value={folderPath}
                    onChange={e => setFolderPath(e.target.value)}
                    placeholder="/path/to/your/videos"
                    onKeyDown={e => e.key === 'Enter' && register()}
                  />
                  <button className="btn-browse" onClick={async () => {
                    const r = await api.pick('folder');
                    if (!r.cancelled && r.path) setFolderPath(r.path);
                  }}>Browse…</button>
                </div>
              </div>
              <div className="form-group">
                <label>Project name</label>
                <input
                  type="text"
                  value={projName}
                  onChange={e => setProjName(e.target.value)}
                  placeholder="Auto-derived from folder"
                  onKeyDown={e => e.key === 'Enter' && register()}
                />
              </div>
              <div className="form-group">
                <label>Logo image</label>
                <div className="input-browse">
                  <input
                    type="text"
                    value={logoPath}
                    onChange={e => setLogoPath(e.target.value)}
                    placeholder="Optional"
                    onKeyDown={e => e.key === 'Enter' && register()}
                  />
                  <button className="btn-browse" onClick={async () => {
                    const r = await api.pick('file');
                    if (!r.cancelled && r.path) setLogoPath(r.path);
                  }}>Browse…</button>
                </div>
              </div>
              <div className="form-group" style={{ flex: '0 0 auto' }}>
                <label>&nbsp;</label>
                <button className="btn btn-primary" onClick={register} disabled={registering}>
                  {registering ? 'Adding…' : 'Add Project'}
                </button>
              </div>
            </div>
            {registerError && <div className="error-msg">{registerError}</div>}
          </div>
        </div>
      </div>
    </div>
  );
}

// ─── App (router) ─────────────────────────────────────────────────────────────

function App() {
  const route = useRoute();
  if (route.screen === 'project') return <ProjectScreen slug={route.slug} />;
  return <ProjectsScreen />;
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
